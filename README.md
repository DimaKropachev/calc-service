# Сервис подсчёта арифметических выражений

## Описание

Этот проект является финальным заданием 1 спринта на курсе **"Программирование на Go"** от Яндекс Лицея. Он представляет из себя простой веб-сервис для вычисления математических выражений, которые передаются пользователем через HTTP-запрос

## Техническое задание

<details> 
  <summary>тык</summary>

## Условия задачи

В конце прошлого модуля вы реализовали программу, которая вычисляла арифметические выражения. Давайте сделаем из неё веб-сервис: пользователь отправляет арифметическое выражение по HTTP и получает в ответ его результат.

У сервиса 1 endpoint с url-ом /api/v1/calculate. Пользователь отправляет на этот url POST-запрос с телом:

```
{
"expression": "выражение, которое ввёл пользователь"
}
```

В ответ пользователь получает HTTP-ответ с телом:

```
{
"result": "результат выражения"
}
```

и кодом 200, если выражение вычислено успешно, либо HTTP-ответ с телом:

```
{
"error": "Expression is not valid"
}
```

и кодом 422, если входные данные не соответствуют требованиям приложения — например, кроме цифр и разрешённых операций пользователь ввёл символ английского алфавита.

Ещё один вариант HTTP-ответа:

```
{
"error": "Internal server error"
}
```

и код 500 в случае какой-либо иной ошибки («Что-то пошло не так»).

## Правила оформления

- Проект размещён на github

- К проекту приложен Readme-файл, в котором подробно описано, что это за проект и как им пользоваться

- К проекту приложены примеры использования со всеми возможными сценариями: программа работает успешно, ошибки 422 и 500. Реализовать это можно с помощью curl:
  ```
  curl --location 'localhost/api/v1/calculate' \
  --header 'Content-Type: application/json' \
  --data '{
    "expression": "2+2*2"
  }'
  ```
- Отдельным блоком в документации идёт инструкция по запуску проекта (желательно, чтобы можно было просто скопировать какую-то команду и запустить ей проект):
`    go run ./cmd/calc_service/...
   `
</details>

## Запуск проекта

0. Прежде чем устанавливать проект убедитесь, что у вас установлен **golang**. Если нет, то скачайте его перейдя по <a href="https://go.dev/dl/">ссылке</a>.<br>Также вам понадобится Git. Скачать его можно по этой <a href="https://git-scm.com/downloads">ссылке</a>
1. Клонируйте данный репозиторий GitHub себе на компьютер:
    ```git
     git clone https://github.com/DimaKropachev/calc-service.git
    ```
2. Перейдите в папку проекта:
    ```
    cd calc-service
    ```
3. Запустите сервер:
    ```
    go run ./cmd/main.go
    ```
4. После запуска сервис будет доступен по адресу:
  http://localhost:8080/api/v1/calculate и вы сможете отправлять на него свои запросы. Дальше будет рассказано как составить и отправить запрос через **curl**.

## Как составить запрос
Расскажу на примере **curl**.

- Сначала пишется `curl`. **curl** - это командная утилита, позволяющая отправлять запросы к веб-серверам и получать ответы.

- Далее с помощью флагов `-X` и `--request` указывается метод запроса.<br>

- Затем обычно пишут необходимые заголовки, которые добавляются с помощью флагов `-H` и `--header`. В пределах данного проекта мы обойдемся только 2 заголовками: `Content-Type`**(обязательный)** и `Accept`**(не обязательный)**.<br>

  `Content-Type` используется для указания формата содержимого в теле `POST` запроса. В данном проекте для корректной работы сервера, значение данного заголовка должно быть равно: `application/json`<br>

  `Accept` используется для того, чтобы сообщить серверу в каком формате вы хотите получить от него ответ. Так как, по условию ТЗ, значение ответа должно быть в формате **JSON**, то значение данного заголовка должно быть `application/json`. В данном проекте этот флаг является не обязательным.

- После заголовков указывается тело запроса с помощью флагов `-d` и `--data`. В данном проекте тело запроса должно иметь следующий вид: `{"expression": "<ваше выражение>"}`

- В конце запроса указывется адрес куда будет адресован запрос. В данном примере адрес указывается с флагом `--location`. Этот флаг используется для автоматического следования за перенаправлениями.

## Примеры запросов
|Запрос|Ответ|Статус ответа|
|:-|:-|:-|
|  `curl --request POST --header "Content-Type: application/json" --data "{\"expression\":\"(2+3)*3-(1+1)\"}" --location "localhost:8080/api/v1/calculate"`|`{"result":13}`|200|
|`curl --request GET --location "localhost:8080/api/v1/calculate"`|`{"error":"Method Not Allowed"}`|405|
|`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": }" --location "localhost:8080/api/v1/calculate"`|`{"error":"Invalid JSON format"}`|400|
|`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": \"*2+3()+\"}" --location "localhost:8080/api/v1/calculate"`|`{"error":"Expression is not valid"}`|422|

## Правила оформления выражений

Калькулятор верно обрабатывает только выражения состоящие из **чисел**, **скобок** и следующих знаков математических операций: **+**, **-**, **\***, **/**. Однако калькулятор пока не может обрабатывать выражения с унарным минусом.

### Примеры выражений

|Выражение|Правильность|
|:--------|:--------|
|`2+2*(2-4/3)*23`|✅|
|`2+2*2`|✅|
|`1+1-(23*124-34/2-(45-3)*34)+124124`|✅|
|`2+-3(45+1*)`|❌|
|`12+()-23`|❌|

## Логирование
 
В данном проекте реализовано "какое-никакое" логирование. Перед запуском сервера создаётся файл ***logfile.txt*** для записи логов. 

### Примеры логов

|Событие/Запрос|Лог|
|:-------------|:--|
|Запуск сервера `go run ./cmd/main.go`|`YYYY/MM/DD HH:MM:SS Сервер запущен на порту: 8080`|
|Запрос с ошибкой<br>`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": }" --location "localhost:8080/api/v1/calculate"`|`YYYY/MM/DD HH:MM:SS Response:`<br>`[ERROR] ошибка при распарсивании JSON: invalid character '}' looking for beginning of value`<br>`YYYY/MM/DD HH:MM:SS Request:`<br>`Method: POST`<br>`Path: /api/v1/calculate`<br>`Request time: 0s`| 
|Запрос без ошибки<br>`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": \"2+2*2\"}" --location "localhost:8080/api/v1/calculate"`|`YYYY/MM/DD HH:MM:SS Response:<br>Result = 6.000000`<br>`YYYY/MM/DD HH:MM:SS Request:`<br>`Method: POST`<br>`Path: /api/v1/calculate`<br>`Request time: 0s`|

## Проверка написания выражения

Проверку выражений на правильность написания осуществляет функция **CheckExpression** из файла <a href="./pkg/calculate/check_expression.go">check_expression.go</a>. Она возвращает одну большую ошибку обо всех неточностях в написании математического выражения.

- ### Примеры ошибки

  |Выражение|Ошибка|
  |:--------|:-----|
  |`+2-3`   |`expression = [+ 2 - 3]`<br>`[ERROR] выражение не должно начинаться с математической операции, expression[0]`| 
  |`+23()-+(34/)-2-`|`expression = [+ 23 ( ) - + ( 34 / ) - 2 -]`<br>`[ERROR] пустая скобка: expression[[2:3]]`<br>`[ERROR] выражение не должно начинаться с математической операции, expression[0]`<br>`[ERROR] выражение не должно заканчиваться математической операцией, expression[12]`<br>`[ERROR] перед закрывающей скобкой одидалось число: expression[9]`<br>`[ERROR] не допускается использование 2 и более математических операций подряд: expression[4]`|

  Изначально планировалось, что ошибка будет выводиться в теле HTTP-ответа. Но из-за того что в некоторых случаях ошибка получается слишком объёмной и выводить её в формате JSON неудобно, было решено выводить данную ошибку в файл для логирования, как результат запроса.

- ### Примеры логов с этой ошибкой

  |Запрос|Лог|
  |:-----|:--|
  |`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": \"2+-(-3/)3 23\"}" --location "localhost:8080/api/v1/calculate"`| `YYYY/MM/DD HH:MM:SS Response:`<br>`Expression is not valid:`<br>`expression = [2 + - ( - 3 / ) 3 23]`<br>`[ERROR] после открывающейся скобки ожидалось число: expression[3]`<br>`[ERROR] перед закрывающей скобкой одидалось число: expression[7]`<br>`[ERROR] после закрываюшейся скобки ожидалась математическая операция: expression[7]`<br>`[ERROR] не допускается использование 2 и более математических операций подряд: expression[1]`<br>`[ERROR] не допускается использование 2 и более чисел подряд: expression[8]`<br>`YYYY/MM/DD HH:MM:SS Request:`<br>`Method: POST`<br>`Path: /api/v1/calculate`<br>`Request time: 1.5462ms`|
  |`curl --request POST --header "Content-Type: application/json" --data "{\"expression\": \"2+()-3-\"}" --location "localhost:8080/api/v1/calculate"`|`YYYY/MM/DD HH:MM:SS Response:`<br>`Expression is not valid:`<br>`expression = [2 + ( ) - 3 -]`<br>`[ERROR] пустая скобка: expression[[2:3]]`<br>`[ERROR] выражение не должно заканчиваться математической операцией, expression[6]`<br>`YYYY/MM/DD HH:MM:SS Request:`<br>`Method: POST`<br>`Path: /api/v1/calculate`<br>`Request time: 0s`|

- ### Подробнее про данную ошибку 

  Ошибка состоит из 2 частей.
  - **1 часть** - это массив с токенами выражения, чтобы было удобнее смотреть где именно ошибся пользователь при вводе выражения.
  
  - **2 часть** - это сами ошибки, с которыми можно ознакомиться <a href="./pkg/errors/errors.go">тут</a>, и индексы токенов выражения, где они возникают.

  Например для выражения: `1/2+12-3(*8)-`, **1 часть** ошибки будет выглядеть следующим образом:
    ```
      expression = [1 / 2 + 12 - 3 ( * 8 ) -]
    ```
  А **2 часть** будет такой:
    ```
      [ERROR] выражение не должно заканчиваться математической операцией, expression[11]
      [ERROR] перед открывающейся скобкой ожидалась математическая операция, expression[7]
      [ERROR] после открывающейся скобки ожидалось число, expression[7]
    ```
